<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Republish an LDES | Onboarding tutorial</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Republish an LDES" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Github repo" /> <meta property="og:description" content="Github repo" /> <link rel="canonical" href="http://localhost:4000/republish/republish" /> <meta property="og:url" content="http://localhost:4000/republish/republish" /> <meta property="og:site_name" content="Onboarding tutorial" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-02-19T16:24:28+01:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Republish an LDES" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-19T16:24:28+01:00","datePublished":"2024-02-19T16:24:28+01:00","description":"Github repo","headline":"Republish an LDES","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/republish/republish"},"url":"http://localhost:4000/republish/republish"}</script> <!-- End Jekyll SEO tag --> <div class="test-header" data-v-df634f57="" data-v-7a7a37b1=""> <div class="global-header" data-v-df634f57=""><img src="/assets/images/LOGO_Vlaanderen_NIV2.svg" alt="Vlaanderen" data-v-df634f57=""><img class="small-global-header-divider" src="/assets/images/divider_globalheader.svg" alt="divider" data-v-df634f57=""><span class="header-title header-font" data-v-df634f57="">Vlaamse Smart Data Space</span><span class="spacer" data-v-df634f57=""></span> <div id="help-needed" data-v-df634f57=""><span class="header-font" data-v-df634f57="">Hulp nodig</span><a id="help" href="https://www.vlaanderen.be/vlaamse-smart-data-space-portaal/contact"><img class="question-menu-item" src="/assets/images/question-mark.svg" alt="?" data-v-df634f57=""></a></div> </div> <hr class="divider" data-v-df634f57=""> </div> <div class="navbar navbar-fixed-top"> <div class="navbar-inner"> <div class="container-fluid"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous"> <a href="https://informatievlaanderen.github.io/VSDS-Tech-Docs/"> <button type="button" class="btn btn-navbar custom-border" > <span class="nav-icon-bar">Home</span> </button> </a> <a href="https://github.com/Informatievlaanderen/VSDS-Onboarding-Example"> <button type="button" class="btn btn-navbar custom-border-activated" > <span class="nav-icon-bar">Tutorial</span> </button> </a> <a href="https://informatievlaanderen.github.io/VSDS-Linked-Data-Interactions/"> <button type="button" class="btn btn-navbar custom-border" > <span class="nav-icon-bar">Linked Data Interactions</span> </button> </a> <a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/"> <button type="button" class="btn btn-navbar custom-border" > <span class="nav-icon-bar">LDES server</span> </button> </a> <a href="https://informatievlaanderen.github.io/VSDS-Linked-Data-Interactions/ldio/ldio-inputs/ldio-ldes-client"> <button type="button" class="btn btn-navbar custom-border" > <span class="nav-icon-bar">LDES client</span> </button> </a> <a href="https://www.vlaanderen.be/vlaamse-smart-data-space-portaal/blog"> <button type="button" class="btn btn-navbar custom-border" > <span class="nav-icon-bar">Blog posts</span> </button> </a> <a href="https://informatievlaanderen.github.io/OSLO-mapping/"> <button type="button" class="btn btn-navbar custom-border" > <span class="nav-icon-bar">OSLO mapping</span> </button> </a> </div> </div> </div> <style> #help-needed[data-v-df634f57] { display: flex; align-items: center; gap: 5px; background-image: url(https://informatievlaanderen.github.io/OSLO-mapping/assets/images/hulp_nodig.svg); width: 144px; height: 44px; } .custom-border-activated { background-color: rgb(255, 230, 21); } .custom-border { border: 0.3px solid rgb(0, 200, 171); /* Randkleur */ /* Voeg hier eventueel andere stijlelementen toe */ } .navbar-fixed-top .navbar-inner { margin-top:30px; height: 35px; padding: 0; border-top: 1px solid #d4d4d4; z-index: 1000; position: fixed; right:0px; } @media (min-width: 50rem) .navbar-fixed-top { position: relative !important; width: auto !important; height: 100% !important; padding: 0; transition: none; } .global-header[data-v-df634f57] { display: flex; margin-left: 0px; align-items: center; position: fixed; width: 100%; background-color: white; z-index: 100; } .test-header{ margin-bottom: 20px; overflow:hidden; z-index: 100; } element.style { } .small-global-header-divider[data-v-df634f57] { margin: 0 8px 0 4px; } .header-font { color: #333332; font-family: Flanders Art Sans, sans-serif; font-size: 12px; font-style: normal; font-weight: 500; line-height: normal; letter-spacing: 0.5px; text-transform: uppercase; } .spacer { flex-grow: 1; } .divider { border: 1px solid #8f8f8f66; margin: 0; } #help-needed > span[data-v-df634f57] { margin-left: 25px; } /* title of the site */ #header { height: 80px; } #header hgroup { position: absolute; top: 10px; left: 20px; } #header h1 { margin: 0; font-size: 1.75em; font-weight: bold; } #header h2 { color: #ccc; margin: 0 0 4px 16px; line-height: 0.8; font-size: 1.0em; font-weight: normal; } #header a, #header a:hover, #header a:visited { text-decoration: none; } .navbar .nav > .active > a, .navbar .nav > .active > a:hover, .navbar .nav > .active > a:focus { box-shadow: none; } .navbar .btn-navbar { margin-bottom: 5px; } </style> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Onboarding tutorial </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Onboarding tutorial</a></li></ul> <div class="nav-category">Publishing an LDES</div> <ul class="nav-list"><li class="nav-list-item"><a href="/publishing/basic_setup" class="nav-list-link">Basic setup</a></li><li class="nav-list-item"><a href="/publishing/minimal_server" class="nav-list-link">Minimal Server</a></li></ul> <div class="nav-category">Data pipeline</div> <ul class="nav-list"><li class="nav-list-item"><a href="/pipeline/minimal_workbench" class="nav-list-link">Minimal workbench</a></li><li class="nav-list-item"><a href="/pipeline/advanced_conversion" class="nav-list-link">Advanced conversion</a></li></ul> <div class="nav-category">Consuming an LDES</div> <ul class="nav-list"><li class="nav-list-item"><a href="/consuming/consuming_public_ldes" class="nav-list-link">Consume a public LDES</a></li><li class="nav-list-item"><a href="/consuming/consuming" class="nav-list-link">Setup a minimal LDES client</a></li></ul> <div class="nav-category">Protected LDES</div> <ul class="nav-list"><li class="nav-list-item"><a href="/protected/publishing_protected_LDES" class="nav-list-link">Publishing a protected LDES</a></li></ul> <div class="nav-category">Republish an LDES</div> <ul class="nav-list"><li class="nav-list-item active"><a href="/republish/republish" class="nav-list-link active">Republish an LDES</a></li></ul> </nav> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Onboarding tutorial" aria-label="Search Onboarding tutorial" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <p><b><a href="https://github.com/Informatievlaanderen/VSDS-Onboarding-Example/tree/main/broker-setup">Github repo</a></b></p> <h1 id="republishing-an-existing-ldes"> <a href="#republishing-an-existing-ldes" class="anchor-heading" aria-labelledby="republishing-an-existing-ldes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Republishing an Existing LDES </h1> <p>This tutorial will show you (as a Data Publisher or a Data Broker) how you can offer different views on a LDES while still keeping your storage and bandwidth costs under control. It will show you how these views can be <em>fragmented</em> in one or more ways and how you can control the <em>retention</em> of members of the available data collections.</p> <h2 id="organise-every-other-day-i-organize"> <a href="#organise-every-other-day-i-organize" class="anchor-heading" aria-labelledby="organise-every-other-day-i-organize"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Organise, Every Other Day I Organize </h2> <p>When offering data collections as a LDES, a Data Publisher can not know all possible use cases of its Data Clients in advance. Therefore a Data Publisher may simply provide a paged view on the LDES. This allows for fully replicating and synchronizing a LDES in a partitioned way. If such a LDES is based on a data collection that continously grows, a couple of problems may arise.</p> <p>Depending on the nature of data collection, the LDES may grow slowly or very fast to a large or even huge unmanageable size which increases the storage costs for a Data Publisher. But also for a Data Client this is cumbersome because when the data collection grows, the time needed to replicate the LDES increases as well as the load on the LDES Server which causes bandwidth issues for the Data Publisher. To keep the storage and bandwidth costs under control, the Data Publisher can specify one or more retention policies for each view. The LDES Server will enforce all retention policies on a view: during a <em>retention background task</em> (which is periodically scheduled) it removes LDES members for which no retention policy applies from a view fragment and, if not referenced in any view, from the database. During a <em>compaction background task</em> the LDES Server verifies how many members are left in related view fragments after retention policy application and, if needed, compacts these fragments by creating new fragments and putting an expiration time on the old sparsely filled fragments. The <em>deletion background task</em> deletes fragments after they expire in addition to deleting any empty fragments. The periodicity of these tasks can be configured in the LDES Server configuration.</p> <p>Currently, the LDES Server allows for a retention policy based on keeping members for a limited period of time (<a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/retention-policies/timebased">time based retention policy</a>) and another retention policy based on keeping a number of versions of an entity (<a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/retention-policies/version-based">version based retention policy</a>). You can even combine these on a LDES view. For details see the <a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/retention-policies/index">Retention Policies</a> section of the LDES Server documentation.</p> <blockquote> <p><strong>Note</strong> that the retention policies do not limit what a Data Client can retrieve but instead limit how long members are available. For example, if a retention policy exists with a sliding windows of one week, a LDES Client that starts to follow a LDES today can replicate one week of history, while a Data Client that starts to follow it in a couple of days will not be able to replicated the oldest couple of days anymore as these members will effectively have been deleted (depending on how often the background tasks run).</p> </blockquote> <p>The process of applying retention policies, the <a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/features/compaction">compaction of fragments</a> and the deleting of obsolete members helps to keep the storage size as well as the bandwidth costs under control. Unfortunately, a paged view still requires a LDES to be fully replicated and synchronized. To solve this issue, the LDES Server offers a few different types of fragmentations.</p> <blockquote> <p><strong>Note</strong> that a paged view is not considered a fragmentation but rather a way to retrieve a data collection fully in parts. In other words, no matter if you fragment or not, you always replicate and synchronize a LDES in a partitioned way.</p> </blockquote> <p>Currently, the LDES server offers three fragmentation strategies: a fragmentation that structures its members according to a hierarchical division of time (<em>Timed based Fragmentation</em>), a fragmentation that organizes its members according to their geographical properties (e. g. location) mapped onto a geo-spatial tiling system (<em>Geo-spatial Fragmentation</em>) and a fragmentation which uses a member property that resolves to an object reference effectively grouping members together with the same property value (<em>Reference Fragmentation</em>). For details see <a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/fragmentations/index">LDES Fragmentations</a>.</p> <blockquote> <p><strong>Note</strong> that the <em>Reference Fragmentation</em> can be used to group members together according to their type(s) allow to replicate and synchronize one type from a multi-typed LDES (i. e. a LDES which contains a data collection with entities of different types).</p> </blockquote> <h3 id="time-is-like-a-clock-in-my-heart"> <a href="#time-is-like-a-clock-in-my-heart" class="anchor-heading" aria-labelledby="time-is-like-a-clock-in-my-heart"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Time Is Like a Clock in My Heart </h3> <p><a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/fragmentations/timebased">Time based fragmentation</a> can be configured with a granularity level set at year, month, etc. up to a second. This creates a hierarchical structure looking like the following (when configured at granularity <code class="language-plaintext highlighter-rouge">hour</code>):</p> <p><img src="./uml/timebased.png" alt="timebased fragmentation" /></p> <p>Fig. 1 - Time based Fragmentation Structure</p> <p>If you require members limited to a period (e. g. December 2023) you can configure the LDES Client to only follow the subtree for that period.</p> <blockquote> <p><strong>Note</strong> that you should not rely on <em>implicit knowledge</em> of the structure (e.g. <code class="language-plaintext highlighter-rouge">/by-time?year=2023&amp;month=12</code>) of a fragmentation as it can always change in future LDES Server versions. Instead you need to start from the LDES or the view and follow the <code class="language-plaintext highlighter-rouge">tree:relation</code>(s) comparing the <code class="language-plaintext highlighter-rouge">tree:value</code> of each relation to the desirable value.</p> </blockquote> <h3 id="around-the-world-around-the-world"> <a href="#around-the-world-around-the-world" class="anchor-heading" aria-labelledby="around-the-world-around-the-world"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Around the World, Around the World </h3> <p><a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/fragmentations/geospatial">Geo-spatial fragmentation</a> is a flat structure containing two levels: a root level (the whole map) and a configurable zoom level. The result is a list of tiles at the configured zoom level (e. g. level 14):</p> <p><img src="./uml/geospatial.png" alt="geospatial fragmentation" /></p> <p>Fig. 2 - Geo-spatial Fragmentation Structure</p> <p>Similar to the time based fragmentation, if you are only interested in a particular tile containing the members for just a few locations, you can again compare the tile’s <code class="language-plaintext highlighter-rouge">tree:value</code>. This value is a representation of a boundingbox containing these locations. E.g. if you <a href="https://clydedacruz.github.io/openstreetmap-wkt-playground/">visualize</a> the WKT value for <code class="language-plaintext highlighter-rouge">tile=14/8360/5483</code> you get:</p> <p><img src="./uml/tile-example.png" alt="time example" /></p> <p>Fig. 3 - Example Tile Visualization</p> <h3 id="just-for-reference-i-stayed-the-same"> <a href="#just-for-reference-i-stayed-the-same" class="anchor-heading" aria-labelledby="just-for-reference-i-stayed-the-same"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Just for Reference, I Stayed the Same </h3> <p><a href="https://informatievlaanderen.github.io/VSDS-LDESServer4J/configuration/fragmentations/reference">Reference fragmentation</a> is very similar to the geo-spatial one as it is also only two level: a root level and a list of possible values for the configured property (e. g. all available types, all available entities, all members that have a certain category, etc.). The result looks something like this:</p> <p><img src="./uml/reference.png" alt="reference fragmentation" /></p> <p>Fig. 4 - Reference Fragmentation Structure</p> <h2 id="were-trading-places-lets-switch-positions"> <a href="#were-trading-places-lets-switch-positions" class="anchor-heading" aria-labelledby="were-trading-places-lets-switch-positions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> We’re Trading Places, Let’s Switch Positions </h2> <p>All these retention options and fragmentations are just great but what if the Data Publisher does not offer a fragmentation that you need? Well, your only option then is to do it yourself and create a view with the required fragmentation and retention. But <em>this</em> is exactly what LDES is meant for: an easy way to replicate and synchronize a data collection!</p> <p>But wait, maybe some Data Broker already had the same problem and already did this? If so, their setup would look something like this:</p> <p><img src="./uml/container.png" alt="data broker setup" /></p> <p>Fig. 5 - Data Broker Setup</p> <p>In this tutorial we will show you how to setup the above starting from the <a href="./advanced-conversion/README.md">Publishing as a standard open linked data model</a> tutorial and combining it partially with the <a href="./minimal-client/README.md">Setting up a minimal LDES Client</a> tutorial.</p> <p>As usual, we start by creating a <a href="./docker-compose.yml">docker compose file</a> containing the services that we need. As you can see in the picture we will need to have a workbench, a server and a database for both the Data Publisher <em>and</em> the Data Broker. To ease the docker network configuration we will use a common network to connect all these services. Obviously, in real world setups the LDES Server would actually be protected behind a API gateway or a reverse proxy and the LDES Client would have to be configured to use some sort of security. See the <a href="./protected-setup/README.md">Publishing and Accessing a Protected LDES</a> for a very simplified example setup.</p> <p>We do not really need to expose the two databases but if we do then we obviously need to map them on a different port on the host:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">publisher-database</span><span class="pi">:</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">protected-setup_publisher-database</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:latest</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">27017:27017</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">common-network</span>

<span class="na">broker-database</span><span class="pi">:</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">protected-setup_broker-database</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:latest</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">27018:27017</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">common-network</span>
</code></pre></div></div> <p>For the Data Publisher, apart from some renaming here and there, both the workbench and server configurations are identical to those from the <a href="./advanced-conversion/README.md">Publishing as a standard open linked data model</a> tutorial. We use the <a href="./publisher-workbench/application.yml">same conversion steps</a> in the workbench (apart from polling every minute at any 30 seconds past the minute) and the <a href="./publisher-server/application.yml">same setup</a> for the server:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">publisher-workbench</span><span class="pi">:</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">protected-setup_publisher-workbench</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">ldes/ldi-orchestrator:2.0.0-SNAPSHOT</span> <span class="c1"># you can safely change this to the latest 1.x.y version</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">./publisher-workbench/config:/ldio/config:ro</span>
    <span class="pi">-</span> <span class="s">./publisher-workbench/application.yml:/ldio/application.yml:ro</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">9004:80</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">common-network</span> 
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">delay-started</span>

<span class="na">publisher-server</span><span class="pi">:</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">protected-setup_publisher-server</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">ldes/ldes-server:2.10.0-SNAPSHOT</span> <span class="c1"># you can safely change this to the latest 2.x.y version</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">./publisher-server/application.yml:/application.yml:ro</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">9003:80</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">common-network</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">publisher-database</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">MANAGEMENT_TRACING_ENABLED=false</span> <span class="c1"># TODO: remove this when pull-based tracing implemented</span>
    <span class="pi">-</span> <span class="s">LDES_SERVER_HOST_NAME=http://publisher-server/ldes</span>
</code></pre></div></div> <blockquote> <p><strong>Note</strong> that we start the workbench later because as usual we first need to seed the server with the LDES and view definitions.</p> </blockquote> <h3 id="so-long-ive-been-looking-too-hard"> <a href="#so-long-ive-been-looking-too-hard" class="anchor-heading" aria-labelledby="so-long-ive-been-looking-too-hard"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> So Long, I’ve Been Looking Too Hard </h3> <p>The Data Broker workbench pipeline is based on a LDES Client which replicates and synchronizes the view exposed by the Data Publisher LDES Server (<code class="language-plaintext highlighter-rouge">LDES_SERVER_URL=http://publisher-server/ldes/occupancy/by-page</code>). Other than that, the workbench and server services are the same as usual:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">broker-workbench</span><span class="pi">:</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">protected-setup_broker-workbench</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">ldes/ldi-orchestrator:2.0.0-SNAPSHOT</span> <span class="c1"># you can safely change this to the latest 1.x.y version</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">./broker-workbench/config:/ldio/config:ro</span>
    <span class="pi">-</span> <span class="s">./broker-workbench/application.yml:/ldio/application.yml:ro</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">9002:80</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">common-network</span> 
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">delay-started</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">LDES_SERVER_URL=http://publisher-server/ldes/occupancy/by-page</span>

<span class="na">broker-server</span><span class="pi">:</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">protected-setup_broker-server</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">ldes/ldes-server:2.10.0-SNAPSHOT</span> <span class="c1"># you can safely change this to the latest 2.x.y version</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">./broker-server/application.yml:/application.yml:ro</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">9001:80</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">common-network</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">broker-database</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">MANAGEMENT_TRACING_ENABLED=false</span> <span class="c1"># TODO: remove this when pull-based tracing implemented</span>
    <span class="pi">-</span> <span class="s">LDES_SERVER_HOST_NAME=http://localhost:9001/ldes</span>
</code></pre></div></div> <blockquote> <p><strong>Note</strong> that the Data Broker exposes the LDES to your local system in order to allow us to verify it. The Data Publisher LDES is only available from within the private docker network as we do not need direct access to it.</p> </blockquote> <p>For the Data Broker workbench we start from the pipeline as defined in <a href="./minimal-client/README.md">Setting up a minimal LDES Client</a> but we add one transformation step which will allow us to add a view later that is <a href="#around-the-world-around-the-world">geo-spatially fragmented</a>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ldio:SparqlConstructTransformer</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">query</span><span class="pi">:</span> <span class="s">./config/occupancy-add-location.rq</span>
    <span class="na">infer</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div> <p>The transformation step takes the latitude and the longitude properties, creates a new blank node and uses a <a href="https://jena.apache.org/documentation/geosparql/#filter-functions">built-in filter function</a> to format these properties as a <a href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry">Well Known Text</a> (WKT) literal and adds a <code class="language-plaintext highlighter-rouge">locn:geometry</code> property which is a <code class="language-plaintext highlighter-rouge">sf:Point</code> having a <code class="language-plaintext highlighter-rouge">geosparql:asWKT</code> with our WKT value:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONSTRUCT {
  ?id locn:geometry ?geometry .
  ?geometry a sf:Point .
  ?geometry geosparql:asWKT ?wkt .
} WHERE {
  ?id rdf:type mv:ParkingLot .
  ?id geo:lat ?lat .
  ?id geo:long ?long .

  bind(bnode() as ?geometry) .
  bind(spatial-f:convertLatLon(?lat, ?long) as ?wkt) .
}
</code></pre></div></div> <blockquote> <p><strong>Note</strong> that in the SPARQL construct we only add these properties and that we do not need to copy the other data. This is possible because in the transformation step we specified that the transformation is cumulative (<code class="language-plaintext highlighter-rouge">infer: true</code>).</p> </blockquote> <p>The resulting <a href="./broker-workbench/application.yml">workbench pipeline</a> then send the modified members to the Data Broker LDES Server (<code class="language-plaintext highlighter-rouge">endpoint: http://broker-server/ldes/occupancy</code>).</p> <h3 id="ive-been-waiting-too-long"> <a href="#ive-been-waiting-too-long" class="anchor-heading" aria-labelledby="ive-been-waiting-too-long"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> I’ve Been Waiting Too Long </h3> <p>OK, we have not been completely honest with you: we did change the LDES view configuration of the Data Publisher a bit because in real-life you will never want to create a LDES which grows indefinitely, would you? We added a retention policy with a sliding window (of five years). As said <a href="#organise-every-other-day-i-organise">earlier</a>, this allows a Data Client which starts following the LDES to always have a history of data. Adding such a retention is pretty simple as we only need to add the following to a <a href="./publisher-server/definitions/occupancy.by-page.ttl">view definition</a>:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldes:retentionPolicy [
  a ldes:DurationAgoPolicy ;
  tree:value "P5Y"^^xsd:duration ;
]
</code></pre></div></div> <p>The real added-value we offer in the Data Broker are the additional fragmentations. We do not offer a paged view because the original LDES already offers such a view with a large history. Instead, we add fragmentations that allow our Data Clients to partially replicate and synchronize the data collection. Say what, <em>partially</em>? Yes, <em>partially</em>. The essence of a LDES view is that it always contains <em>all</em> members of the data collection, no matter how it is fragmented (or simply partitioned using a paged view). So, if a client needs all members there is no point in using any of our views as you can get them from the original Data Publisher’s paged view. But, of course, if you need a smaller subset of the data collection then our views are ideal. Well, it depends. It depends on how much history we offer and how much you need. So, which views do we add and how much history do we offer? Obviously this is a business decision which depends on your needs and your client’s needs. You need to decide this balancing the cost of storage, the cost of the bandwidth, the cost of hosting, your price policy if you do not offer this service for free, etc. For this tutorial we add three fragmentations to show how to configure the different fragmentations and retention policies and how this influences the server’s behavior for cleaning up the views and data collection.</p> <p>Our first fragmentation is one <a href="#time-is-like-a-clock-in-my-heart">by time</a> allowing a client to retrieve the occupancy of our parking lots for a particular time interval (i.e. January 2024). Depending on when a client starts following our view it will only replicate the data collection partially (if the time period has already elapsed) or it will in addition also synchronize with the new occupancy values until the end of the time period. Our view definition looks like this (only showing the relevant parts, see the <a href="./broker-server/definitions/occupancy.by-time.ttl">by-time definition</a> for the complete picture):</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tree:fragmentationStrategy ([
  a tree:HierarchicalTimeBasedFragmentation ;
  tree:maxGranularity "hour" ;
  tree:fragmentationPath dcterms:modified ;
]) ;

tree:pageSize "50"^^xsd:integer ;

ldes:retentionPolicy [
  a ldes:DurationAgoPolicy ;
  tree:value "P3M"^^xsd:duration ;
] ;
</code></pre></div></div> <blockquote> <p><strong>Notes</strong>:</p> <ul> <li>the <code class="language-plaintext highlighter-rouge">tree:fragmentationStrategy</code> is a list <code class="language-plaintext highlighter-rouge">(...)</code> containing one fragmentation <code class="language-plaintext highlighter-rouge">[...]</code> of type <code class="language-plaintext highlighter-rouge">tree:HierarchicalTimeBasedFragmentation</code> which groups together (<em>bucketizing</em>) members by property <code class="language-plaintext highlighter-rouge">tree:fragmentationPath dcterms:modified</code> organizing it in a structure up to <code class="language-plaintext highlighter-rouge">tree:maxGranularity "hour"</code>.</li> <li>we set the <code class="language-plaintext highlighter-rouge">tree:pageSize</code> of the view to 50 members which does not affect our structure nodes but does limit the number of members returned per page node. As we follow 5 parking lots and poll every minute we will end up with 10 minutes of data in each page.</li> <li>for this view we chose to offer at most three months of data by definiting a sliding time window retention policy <code class="language-plaintext highlighter-rouge">ldes:DurationAgoPolicy</code> with the <code class="language-plaintext highlighter-rouge">tree:value</code> specified as a <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO8601 duration</a>.</li> </ul> </blockquote> <p>To allow retrieving a part of the data collection <a href="#around-the-world-around-the-world">by location</a> we add a <a href="./broker-server/definitions/occupancy.by-location.ttl">by-location definition</a>. The relevant parts are:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tree:fragmentationStrategy ([
  a tree:GeospatialFragmentation ;
  tree:maxZoom "14"^^xsd:integer ;
  tree:fragmentationPath geosparql:asWKT 
]) ;

tree:pageSize "100"^^xsd:integer ;

ldes:retentionPolicy [
  a ldes:DurationAgoPolicy ;
  tree:value "P7D"^^xsd:duration ;
]
</code></pre></div></div> <blockquote> <p><strong>Notes</strong>:</p> <ul> <li>we define a <code class="language-plaintext highlighter-rouge">tree:GeospatialFragmentation</code> at <code class="language-plaintext highlighter-rouge">tree:maxZoom "14"^^xsd:integer</code> (zoom level) based on a <code class="language-plaintext highlighter-rouge">tree:fragmentationPath geosparql:asWKT</code> property. Remember we added this property in a <a href="./broker-workbench/config/occupancy-add-location.rq">transformation</a>?</li> <li>we chose a <code class="language-plaintext highlighter-rouge">tree:pageSize</code> of 100 this time just because we can.</li> <li>again, we chose time fragmentation based on a sliding time window (of one week).</li> </ul> </blockquote> <p>Finally, we also allow to retrieve data of a single parking lot by using its idenfier. For that we use a <a href="#just-for-reference-i-stayed-the-same">reference fragmentation</a> and configure a <a href="./broker-server/definitions/occupancy.by-parking.ttl">by-parking definition</a>:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  tree:fragmentationStrategy ([
    a tree:ReferenceFragmentation ;
    tree:fragmentationPath terms:isVersionOf ; 
    tree:fragmentationKey "parking-lot"
  ]) ;

  tree:pageSize "15"^^xsd:integer ;

  ldes:retentionPolicy [
    a ldes:LatestVersionSubset ;
    ldes:amount 15 ;
  ]
</code></pre></div></div> <blockquote> <p><strong>Notes</strong>:</p> <ul> <li>this time we use a <code class="language-plaintext highlighter-rouge">tree:ReferenceFragmentation</code> on the member’s <code class="language-plaintext highlighter-rouge">terms:isVersionOf</code> property and use <code class="language-plaintext highlighter-rouge">parking-lot</code> in the URLs.</li> <li>we limit the history to the most recent occupancy values by using using retention policy <code class="language-plaintext highlighter-rouge">ldes:LatestVersionSubset</code> with <code class="language-plaintext highlighter-rouge">ldes:amount 15</code>.</li> <li>we keep at most 15 members per parking lot and fit all of them into one page by setting <code class="language-plaintext highlighter-rouge">tree:pageSize "15"^^xsd:integer</code>.</li> <li>if we do not set the retention job to run frequently, we may end up with a lot more versions than we configured so please ensure you balance these correctly.</li> </ul> </blockquote> <h3 id="let-me-tell-you-bout-hard-work"> <a href="#let-me-tell-you-bout-hard-work" class="anchor-heading" aria-labelledby="let-me-tell-you-bout-hard-work"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Let Me Tell You ’Bout Hard Work </h3> <p>Although typically we send our view definitions to the LDES server before ingesting our data collection this is <em>not</em> actually needed. As soon as we have defined our LDES the server can start ingesting the members. But, unless we define a view, the ingested members are inaccessible. They will be ingested into the server’s database and stay there forever without anyone being able to retrieve them. Not very useful. So we need at least one view. If this view does not specify a retention policy the data collection becomes available but will still continue to grow indefinitely. At some point our storage and bandwidth costs will rise to an unacceptable amount and guess who will get fired?! OK, so we add a retention policy to our view. Crisis diverted!</p> <p>So, we now know that we can add and remove views as we see fit at any time. Now what happens if we add multiple views to our server? How do the different retention policies interact? How long will our members be available in each view and when will they actually be removed from the server’s database to save storage space?</p> <p>The rules are simple: when a retention policy of a view does not apply to a member (e. g. it is older than the view’s retention time or it is not part of the set of latest versions) then that member is removed from that view’s fragment(s) and when a member is removed from all views it is actually deleted. The retention background task is responsible for checking the retention policies and deleting members in order to release actual storage space. Removing members from a view’s fragment(s) results in half-empty or even empty fragments. These empty fragments are removed and the partially filled fragments are joined together. This is done by the compaction background task.</p> <p>Summarized, you need to create at least one view to allow retrieving a data collection. You need to add a retention policy to every view of a LDES in order to ensure members can be actually deleted (i. e. if one view does not have a retention policy, members are never deleted!). A view with a retention policy keeps your storage under control by allowing removal of members from the view’s fragments and from the database. Multiple retention policies are combined to ensure a member is not removed while there is at least one view which still contains the member. Retention policy enforcement, fragment compaction and member deletion are done in background tasks which are scheduled independently according to a customizable schedule.</p> <p>The background tasks have a predefined schedule but we can change the default configuration in the LDES Server <a href="./publisher-server/application.yml">application configuration</a> using a <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/support/CronExpression.html#method-detail">cron pattern</a>. Here is an example:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ldes-server</span><span class="pi">:</span>

  <span class="c1"># checks the retention policy on view members, deleting obsolete members</span>
  <span class="na">retention-cron</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*"</span> <span class="c1"># run daily at 02:00</span>

  <span class="c1"># compacts data fragments (creating new combined fragments, expiring the old ones) </span>
  <span class="na">compaction-cron</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">4</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">7"</span> <span class="c1"># run weekly at 04:00 on Sundays</span>
  <span class="na">compaction-duration</span><span class="pi">:</span> <span class="s">P5D</span> <span class="c1"># time period to keep the old fragments</span>

  <span class="c1"># removes expired and empty data fragments</span>
  <span class="na">deletion-cron</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*"</span> <span class="c1"># run monthly at 03:00 on 1st of the month</span>
</code></pre></div></div> <blockquote> <p><strong>Note</strong> that we also added a <code class="language-plaintext highlighter-rouge">compaction-duration</code> which defines how long the obsolete sparsely filled fragments are kept around before actually being deleted. We need to do this to ensure that any Data Client following a view (at the fragments being compacted) had enough time to catch up with the stream so that we can safely remove the obsolete fragments without breaking the some Data Client’s flow.</p> </blockquote> <h2 id="launch-systems--check-views"> <a href="#launch-systems--check-views" class="anchor-heading" aria-labelledby="launch-systems--check-views"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Launch Systems &amp; Check Views </h2> <p>To see our Data Broker setup in action, you can use the following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clear

<span class="c"># start and wait for the servers and databases</span>
docker compose up <span class="nt">-d</span>
<span class="k">while</span> <span class="o">!</span> docker logs <span class="si">$(</span>docker ps <span class="nt">-q</span> <span class="nt">-f</span> <span class="s2">"name=publisher-server$"</span><span class="si">)</span> 2&gt; /dev/null | <span class="nb">grep</span> <span class="s1">'Started Application in'</span> <span class="p">;</span> <span class="k">do </span><span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done
while</span> <span class="o">!</span> docker logs <span class="si">$(</span>docker ps <span class="nt">-q</span> <span class="nt">-f</span> <span class="s2">"name=broker-server$"</span><span class="si">)</span> 2&gt; /dev/null | <span class="nb">grep</span> <span class="s1">'Started Application in'</span> <span class="p">;</span> <span class="k">do </span><span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># upload Data Publisher LDES &amp; view definitions</span>
curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"content-type: text/turtle"</span> <span class="s2">"http://localhost:9003/ldes/admin/api/v1/eventstreams"</span> <span class="nt">-d</span> <span class="s2">"@./publisher-server/definitions/occupancy.ttl"</span>
curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"content-type: text/turtle"</span> <span class="s2">"http://localhost:9003/ldes/admin/api/v1/eventstreams/occupancy/views"</span> <span class="nt">-d</span> <span class="s2">"@./publisher-server/definitions/occupancy.by-page.ttl"</span>

<span class="c"># upload Data Broker LDES &amp; view definitions</span>
curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"content-type: text/turtle"</span> <span class="s2">"http://localhost:9001/ldes/admin/api/v1/eventstreams"</span> <span class="nt">-d</span> <span class="s2">"@./broker-server/definitions/occupancy.ttl"</span>
curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"content-type: text/turtle"</span> <span class="s2">"http://localhost:9001/ldes/admin/api/v1/eventstreams/occupancy/views"</span> <span class="nt">-d</span> <span class="s2">"@./broker-server/definitions/occupancy.by-time.ttl"</span>
curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"content-type: text/turtle"</span> <span class="s2">"http://localhost:9001/ldes/admin/api/v1/eventstreams/occupancy/views"</span> <span class="nt">-d</span> <span class="s2">"@./broker-server/definitions/occupancy.by-location.ttl"</span>
curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"content-type: text/turtle"</span> <span class="s2">"http://localhost:9001/ldes/admin/api/v1/eventstreams/occupancy/views"</span> <span class="nt">-d</span> <span class="s2">"@./broker-server/definitions/occupancy.by-parking.ttl"</span>

<span class="c"># start and wait for the publisher workbench</span>
docker compose up publisher-workbench <span class="nt">-d</span>
<span class="k">while</span> <span class="o">!</span> docker logs <span class="si">$(</span>docker ps <span class="nt">-q</span> <span class="nt">-f</span> <span class="s2">"name=publisher-workbench$"</span><span class="si">)</span> 2&gt; /dev/null | <span class="nb">grep</span> <span class="s1">'Started Application in'</span> <span class="p">;</span> <span class="k">do </span><span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>

<span class="c"># start and wait for the broker workbench</span>
docker compose up broker-workbench <span class="nt">-d</span>
<span class="k">while</span> <span class="o">!</span> docker logs <span class="si">$(</span>docker ps <span class="nt">-q</span> <span class="nt">-f</span> <span class="s2">"name=broker-workbench$"</span><span class="si">)</span> 2&gt; /dev/null | <span class="nb">grep</span> <span class="s1">'Started Application in'</span> <span class="p">;</span> <span class="k">do </span><span class="nb">sleep </span>1<span class="p">;</span> <span class="k">done</span>
</code></pre></div></div> <p>You can already check the existence of our additional Data Broker views using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://localhost:9001/ldes/occupancy/by-time
curl http://localhost:9001/ldes/occupancy/by-location
curl http://localhost:9001/ldes/occupancy/by-parking
</code></pre></div></div> <p>After a bit of time data will start appearing in these views. Replicating the history of the Data Publisher data collection will be almost instantaneous in our case because we just started the Data Publisher’s systems. After that the synchronization happens almost immediately as well because the source data produces only 5 members per minute. Basically, you should see all views grow by 5 members every minute.</p> <p>You can also check how long members are available in each view and when your members and fragments are deleted. For these you will need to look inside your database using tools like <a href="https://www.mongodb.com/products/tools/compass">MongoDB Compass</a>.</p> <blockquote> <p><strong>Note</strong> that in order to show you the retention, compaction and deletion in action we have lowered the retention periods to hours and minutes and increased the frequency of the background tasks. Make sure you balance the schedule configurations correctly as these tasks put some load on your systems as the amount of members increases.</p> </blockquote> <h2 id="cleanup"> <a href="#cleanup" class="anchor-heading" aria-labelledby="cleanup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Cleanup </h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose <span class="nb">rm </span>broker-workbench <span class="nt">--stop</span> <span class="nt">--force</span> <span class="nt">--volumes</span>
docker compose <span class="nb">rm </span>publisher-workbench <span class="nt">--stop</span> <span class="nt">--force</span> <span class="nt">--volumes</span>
docker compose down
</code></pre></div></div> </main> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0"></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>
